<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Compass</title>

    <link rel='stylesheet' href='/static/bootstrap/css/bootstrap.css'>
    <script src="/static/jquery/2.0.0/jquery.min.js"></script>
    <script src="/static/bootstrap/js/bootstrap.js"></script>
    <script src="/static/utils/stringFormat.js"></script>

    <!-- START SIGMA IMPORTS -->
    <script src="/static/sigma.js-1.2.1/src/sigma.core.js"></script>
    <script src="/static/sigma.js-1.2.1/src/conrad.js"></script>
    <script src="/static/sigma.js-1.2.1/src/utils/sigma.utils.js"></script>
    <script src="/static/sigma.js-1.2.1/src/utils/sigma.polyfills.js"></script>
    <script src="/static/sigma.js-1.2.1/src/sigma.settings.js"></script>
    <script src="/static/sigma.js-1.2.1/src/classes/sigma.classes.dispatcher.js"></script>
    <script src="/static/sigma.js-1.2.1/src/classes/sigma.classes.configurable.js"></script>
    <script src="/static/sigma.js-1.2.1/src/classes/sigma.classes.graph.js"></script>
    <script src="/static/sigma.js-1.2.1/src/classes/sigma.classes.camera.js"></script>
    <script src="/static/sigma.js-1.2.1/src/classes/sigma.classes.quad.js"></script>
    <script src="/static/sigma.js-1.2.1/src/classes/sigma.classes.edgequad.js"></script>
    <script src="/static/sigma.js-1.2.1/src/captors/sigma.captors.mouse.js"></script>
    <script src="/static/sigma.js-1.2.1/src/captors/sigma.captors.touch.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/sigma.renderers.canvas.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/sigma.renderers.webgl.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/sigma.renderers.svg.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/sigma.renderers.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/webgl/sigma.webgl.nodes.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/webgl/sigma.webgl.nodes.fast.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/webgl/sigma.webgl.edges.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/webgl/sigma.webgl.edges.fast.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/webgl/sigma.webgl.edges.arrow.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edges.curve.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/svg/sigma.svg.utils.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/svg/sigma.svg.nodes.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/svg/sigma.svg.edges.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/svg/sigma.svg.edges.curve.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/svg/sigma.svg.labels.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/renderers/svg/sigma.svg.hovers.def.js"></script>
    <script src="/static/sigma.js-1.2.1/src/middlewares/sigma.middlewares.rescale.js"></script>
    <script src="/static/sigma.js-1.2.1/src/middlewares/sigma.middlewares.copy.js"></script>
    <script src="/static/sigma.js-1.2.1/src/misc/sigma.misc.animation.js"></script>
    <script src="/static/sigma.js-1.2.1/src/misc/sigma.misc.bindEvents.js"></script>
    <script src="/static/sigma.js-1.2.1/src/misc/sigma.misc.bindDOMEvents.js"></script>
    <script src="/static/sigma.js-1.2.1/src/misc/sigma.misc.drawHovers.js"></script>
    <script src="/static/sigma.js-1.2.1/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
    <script src="/static/sigma.js-1.2.1/plugins/sigma.layout.forceAtlas2/worker.js"></script>
    <script src="/static/sigma.js-1.2.1/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>
    <!-- END SIGMA IMPORTS -->
</head>
    <body>
        <div id="initDom">
            <br><br>
            <div id="brand" class='container'>
                <br><br>
                <div class='row'>
                    <div style="text-align: center;">
                        <a class='branding' href='/' title='compass(指南针)'>
                            <img src='/static/assets/img/iconfont-iconyonghuzhinan.png' style='width:80px; height:80px;' style="margin: 0 auto;">
                        </a>
                    </div>
                </div>
            </div>
            <div id="searchBox" class='container'>
                <br><br>
                <div class='row'>
                    <div class='col-lg-6'>
                        <form onsubmit="return false;">
                            <div class="input-group">
                                <span class="input-group-btn">
                                   <button style="background-color:#0099ff" class="btn btn-default" id="submitBTN">Go!</button>
                                </span>
                                <input type="text" id = "queryText" class="form-control" placeholder="keywords">
                            </div>
                        </form>
                        <div id="notification"></div>
                    </div>
                    <div class='col-lg-6'>
                        <div id="developerInfo"></div>
                        <div id="prInfo"></div>
                    </div>
                </div>
            </div>
            <br><br>
            <div id="result" class='container'>
                <div class="row">
                    <div class='col-lg-6'>
                        <div id='graph'></div>
                    </div>
                    <div class='col-lg-6'>
                        <div id='code' style='height:400px; overflow:auto;'></div>
                    </div>
                </div>
            </div>      
        </div>
    </body>
    <script type="text/javascript">
        function searchInfo(fileID, lineID, codeLine) {
            $.ajax({
                type: "POST",
                url: "/getLineInfo",
                data: JSON.stringify({'fileID': fileID, 'lineID':lineID}),
                dataType: "json",
                success: function (message) {
                    var developerName = message['developerName'];
                    showDeveloperInfo(developerName);
                    var lineNumList = message['lineNumList'];
                    var lineStartNum = getStartLineNum(fileID);
                    var lineEndNum = getEndLineNum(fileID);
                    for (var i=lineStartNum; i<lineEndNum; i++) {
                        document.getElementById(fileID+'_'+i.toString()).style.color="black";
                    }
                    for (var i=0; i<lineNumList.length; i++) {
                        document.getElementById(fileID+'_'+lineNumList[i]).style.color="blue";
                    }
                },
                error: function (message) {

                }
            });
            $.ajax({
                type: "POST",
                url: "/getPRInfo",
                data: JSON.stringify({'codeLine': codeLine}),
                dataType: "json",
                success: function (message) {
                    var prLinks = message['prLinks'];
                    showPRInfo(prLinks);
                },
                error: function (message) {

                }
            });
        }

        function getStartLineNum(fileID) {
            return parseInt(fileID.slice(8,16));
        }

        function getEndLineNum(fileID) {
            return parseInt(fileID.slice(16,24));
        }


        function createCodeDom(codeSections) {
            var HTML = "";
            console.warn(codeSections);
            for (var fileID in codeSections) {
                count = 0;
                for (lineID in codeSections[fileID]) {
                    var lineNUM = getStartLineNum(fileID) + count;
                    HTML = HTML + `
                        <pre id="{3}" onmouseover="searchInfo('{1}', {2}, '{0}')">{0}</pre>
                    `.format(codeSections[fileID][lineID], fileID, lineID, fileID+'_'+lineNUM);
                    count = count + 1;
                }
            }
            document.getElementById("code").innerHTML = HTML;
        }
        function createNotificationDom(text, type) {
            document.getElementById("notification").innerHTML = `
                <div class="alert alert-{1}" role="alert">{0}</div>
            `.format(text, type);
        }
        function cleanNotificationDom() {
            document.getElementById("notification").innerHTML = '';
        }
        function createResultDom(graph) {
            var nodes = graph[0];
            var edges = graph[1];
            var nodeDict = Object();
            for (var i=0; i<nodes.length; i++) {
                nodeDict[nodes[i][1]] = nodes[i][0]
            }
            var relations = [];
            for (var i=0; i<edges.length; i++) {
                var from = nodeDict[edges[i][0]];
                var to = nodeDict[edges[i][1]];
                if (from != null && to != null) {
                    relations.push([from, to]);
                }
            }
            createViz(relations);
        }
        function removeBrand() {
            document.getElementById("brand").innerHTML = "";
        }
        function showDeveloperInfo(info) {
            document.getElementById("developerInfo").innerHTML = info;
        }
        function showPRInfo(prLinks) {
            for (var i=0; i<prLinks.length; i++) {
                document.getElementById("prInfo").innerHTML = prLinks[i];
            }
        }
    </script>
    <script type="text/javascript">
        $("#submitBTN").click(function() {
            var queryText = document.getElementById("queryText").value;
            createNotificationDom("waiting...", "info");
            $.ajax({
                type: "POST",
                url: "/search",
                data: JSON.stringify({'query': queryText}),
                dataType: "json",
                success: function (message) {
                    removeBrand();
                    cleanNotificationDom();
                    createResultDom(message['graph']);
                },
                error: function (message) {
                    createNotificationDom("error!", "danger");
                }
            });
        });
    </script>
    <script type="text/javascript">
        function ifIsInNodeList(nodeList, nodeID) {
            for (var i=0; i<nodeList.length; i++) {
                if (nodeList[i]['id']==nodeID) {
                    return true;
                }
            }
            return false;
        }

        function ifIsInEdgeList(edgeList, edgeID) {
            for (var i=0; i<edgeList.length; i++) {
                if (edgeList[i]['id']==edgeID) {
                    return true;
                }
            }
            return false;
        }

        function createViz(relations) {
            document.getElementById('graph').innerHTML = `
            <div id="graph-container" style='width:600px; height:400px;'></div>`;
            var i,
            s,
            g = {
              nodes: [],
              edges: []
            };

            // Generate a random graph:
            for (i = 0; i < relations.length; i++) {
                if (!ifIsInNodeList(g.nodes, relations[i][0])) {
                    g.nodes.push({
                        id: relations[i][0],
                        label: relations[i][0],
                        x: Math.random(),
                        y: Math.random(),
                        size: 5,
                        color: '#666'
                    });
                }
                if (!ifIsInNodeList(g.nodes, relations[i][1])) {
                    g.nodes.push({
                        id: relations[i][1],
                        label: relations[i][1],
                        x: Math.random(),
                        y: Math.random(),
                        size: 5,
                        color: '#666'
                    });
                }
            }

            for (i = 0; i < relations.length; i++) {
                if (!ifIsInEdgeList(g.edges, relations[i][0]+'->'+relations[i][1])) {
                    g.edges.push({
                        id: relations[i][0]+'->'+relations[i][1],
                        source: relations[i][0],
                        target: relations[i][1],
                        size: 0.5,
                        color: '#ccc'
                    });
                }
            }
            // sigma.renderers.def = sigma.renderers.canvas
            // Instantiate sigma:
            var s = new sigma({
                graph: g,
                container: 'graph-container',
                settings: {
                    labelSize: "proportional",
                    labelThreshold: 10,
                    labelSizeRatio: 3,
                    autoRescale: false,
                    zoomingRatio: 3,
                    zoomMax: 20,
                    zoomMin: 0.0001,
                }
            });

            // Initialize the dragNodes plugin:
            var dragListener = sigma.plugins.dragNodes(s, s.renderers[0]);

            dragListener.bind('startdrag', function(event) {
                //console.log(event);
            });
            dragListener.bind('drag', function(event) {
                //console.log(event);
            });
            dragListener.bind('drop', function(event) {
                //console.log(event);
            });
            dragListener.bind('dragend', function(event) {
                //console.log(event);
            });

            s.bind('click', function(event) {
                s.stopForceAtlas2();
            });

            s.bind('clickNode', function(event) {
                var declaration = event['data']['node']['label'];
                $.ajax({
                    type: "POST",
                    url: "/getCodeSection",
                    data: JSON.stringify({'declaration': declaration}),
                    dataType: "json",
                    success: function (message) {
                        showDeveloperInfo('');
                        createCodeDom(message['codeSection']);
                    },
                    error: function (message) {
                        
                    }
                });
            });

            // Start the ForceAtlas2 algorithm:
            s.startForceAtlas2({barnesHutOptimize: true, linLogMode: true});
        }

    </script>
</html>
